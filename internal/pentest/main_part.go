package pentest

import (
	"Container_runtime_scanner/internal/data"
	"Container_runtime_scanner/internal/docker"
	"fmt"
	"log"
	"os"
	"path/filepath"
)

func VerifyVul(cont *docker.Container) {
	if !cont.IsDocker() {
		log.Fatalf("该系统不是容器")
	}
	// 打开日志文件（追加模式）
	logFile, err := os.OpenFile("./internal/data/LOG/"+cont.Name+"_scan.log", os.O_CREATE|os.O_WRONLY, 0644)

	if err != nil {
		log.Fatalf("无法打开日志文件: %v", err)
	}
	defer logFile.Close()

	// 创建日志记录器
	logger := log.New(logFile, "", log.LstdFlags)

	pocs := data.ReadFile("internal/data/database.json")
	for _, poc := range pocs {
		logger.Println("----------------------")
		logger.Printf("POC: %s\n描述: %s\n", poc.PocName, poc.Description)

		output := cont.Exec("sh", "-c", poc.TestCmd)
		logger.Println("\npoc.TestCmd:\n", poc.TestCmd)
		logger.Println("output:\n", output)

		if data.RegexGetBool(poc.ExpectedOutput, output) {
			logger.Println("该漏洞可能存在")
			cont.ExecStep(poc.ExploitationSteps)

			verify_response := cont.ExecStep(poc.VerifySteps)
			if data.RegexGetBool(poc.VerifyOutput, verify_response) {
				logger.Println("验证漏洞成功，并成功逃逸·")
			} else {
				logger.Println("逃逸失败")
			}

			logger.Println("删除测试记录")
			cont.ExecStep(poc.LastStep)
		} else {
			logger.Println("该漏洞不存在")
		}

		logger.Println("----------------------")
	}
}

func start() {
	tmpDir := os.TempDir()
	filePath := filepath.Join(tmpDir, "Container_runtime_scanner")
	file, err := os.Create(filePath)
	if err != nil {
		log.Fatalf("文件创建失败: %v", err)
	}
	_, err = file.WriteString("Container_runtime_scanner_123456")
	if err != nil {
		log.Fatalf("文件写入失败: %v", err)
	}
	err1 := file.Close()
	if err1 != nil {
		return
	}

	fmt.Printf("文件已创建: %s\n", filePath)
}
func end() {
	tmpDir := os.TempDir()
	filePath := filepath.Join(tmpDir, "Container_runtime_scanner")
	if err := os.Remove(filePath); err != nil {
		log.Fatalf("文件删除失败: %v", err)
	}
	fmt.Printf("文件已删除: %s\n", filePath)
}
func Run() {
	start()
	containers := docker.ListRunningContainers()
	for _, cont := range containers {
		VerifyVul(cont)
	}
	end()

}
